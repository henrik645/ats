local settingsFilePath = "apis/networkSettings"
os.loadAPI("apis/logging")
os.loadAPI("apis/validate")

function initialise() -- initialises the settings file
    if fs.exists(settingsFilePath) then
        settingsFile = fs.open(settingsFilePath, "r")
        settings = textutils.unserialize(settingsFile.readAll()) -- takes care of the serialized settings file
        settingsFile.close()
    else
        logging.errorMsg("networking: could not find settings file")
    end
end

function sendMessage(modem, recipient, port, replyPort, data) -- sends a message on the network
    if not validate.tableHasKeys(modem, {"transmit"}) or not validate.areNumbers({port, replyPort}) then
        logging.errorMsg("networking: sendMessage: incorrect parameters")
    end
    
    modem.transmit(port, replyPort, {
        recipient = recipient,
        port = port,
        replyPort = replyPort,
        data = data
    }
    )
end

function receiveMessage(modem, port, timeout) -- takes care of receiving a message, returns false if no data received during timeout
    if not validate.tableHasKeys(modem, {"open", "close"}) or not validate.areNumbers({port, replyPort}) then
        logging.errorMsg("networking: receiveMessage: incorrect parameters")
    end
    
    local timer = os.startTimer(timeout)
    modem.open(port)
    while true do
        local event, _, _, _, message, _ = os.pullEvent()
        logging.infoMsg("networking: receiveMessage: event is " .. event)
        
        if event == "timer" then
            return false
        elseif event == "modem_message" then
            data = handleMessage(message)
            logging.infoMsg("networking: receiveMessage: data is " .. data)
            if not data == false then
                os.cancelTimer(timer) -- makes sure the timer isn't running in the background
                logging.infoMsg("networking: receiveMessage: data is " .. data)
                return data
            end
        end
    end
    modem.close(port)
end

function handleMessage(message) -- handles a message if you want to catch it yourself
    if not validate.tableHasKeys(message, {"recipient", "port", "replyPort", "data"}) or not validate.tableHasKey(settings, "nodeName") then -- tables don't contain the right things
        logging.errorMsg("networking: handleMessage: message or settings not formatted correctly")
    end
    
    if message.recipient == settings.nodeName then
        logging.infoMsg("networking: handleMessage: Returning message data... is " .. message.data)
        return message.data
    else
        return false
    end
end